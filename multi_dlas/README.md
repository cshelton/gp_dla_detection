# Modifications for detecting multi-DLAs

The code in this `multi_dlas` folder can be used to completely
reproduce the multi-DLA catalogue reported in

> M-F Ho, S Bird, and R Garnett. Detecting Multiple DLAs per
> Spectrum in SDSS DR12 with Gaussian Processes. [arXiv:2003.11036
> [astro-ph.CO]](https://arxiv.org/abs/2003.11036),

the `CDDF_analysis` folder has the post-process python scripts to
reproduce the plots in the paper. The `.mat` files used in the python
scripts in `CDDF_analysis` are generated by the MATLAB files in this
`multi_dlas` folder (those scripts are also compatible with Garnett (2017)
catalogue.)

The processing stages are almost identical to the single-DLA model
except the following changes:

- `set_parameters.m` is replaced with `set_parameters_multi.m`
- `learn_qso_model.m` is replaced with `learn_qso_model_meanflux.m`
- `process_qsos.m` is replaced with `process_qsos_multiple_dlas_meanflux.m`
- and running `set_lls_parameters.m` before running the `process_qsos_multiple_dlas_meanflux.m`

## Z-Warning Flags

You can either choose to rerun the `build_catalogs`:

```matlab
% in MATLAB
set_parameters;
build_catalog;

% preload catalog.mat, save new flags, and save to preloaded_qsos.mat
preload_qsos;
```

Or, if you haven't run the `download_catalogs.sh` before,
but you happen to have the `catalog.mat` file and `DR12Q.fits` file,
you can run the patch `zwarning_patch.m`.
This will add zwarning in the `filter_flags` (5th bit) variable in `catalog.mat`.

```matlab
% update the filter_flags
zwarning_patch;

% run again to build new preloaded_qsos.mat
preload_qsos;
```

Note running `preload_qsos.m` again is not necessary
if you want to keep track all of your spectra with or without zwarning.
You can always filtering out the zwarning spectra in the post-processing step
after you get the `processed_qsos.mat`.

## Re-learn the GP null model

The modifications we done here for multi-DLAs are:

1. Considering sub-DLAs (1.95 < lognhi < 20.3) as an alternative model. 
   1. `set_lls_parameters.m` : for generating the samples for sub-DLAs
   2. `process_qsos_multiple_dlas(_meanflux).m`: will generate `sample_log_likelihoods_lls` and will suppress the probability of DLAs in the `model_posteriors`.
2. Occam's razor: we consider when we are sampling in 2-DLAs, we should divide the likelihood using 2*N (where N is the number of samples we used to sample 1-DLA uniformly). The reason is probability density should be summed to unity and we are sampling in a larger parameter space for 2-DLAs. So, in `process_qsos_multiple_dlas_meanflux.m`:

```matlab
    log_likelihoods_dla(quasar_ind, num_dlas) = ...
    max_log_likelihood + log(nanmean(sample_probabilities)) ...
    - log( num_dla_samples ) * (num_dlas - 1); % occam's razor
```

3. Allow the mean vector to change with Kim's prior (effective optical depth):
   1. `learn_qso_model_meanflux.m`: train on GP with fluxes without effective optical depth.
   2. `process_qsos_multiple_dlas_meanflux.m`: suppress the GP mean with effective optical depth
4. default parameter changes:
   1. `alpha = 0.90 -> alpha = 0.97`: we prefer the data prior more.

Here are what we really have to rerun:

First, relearn the GP null model:

```matlab
training_release  = 'dr12q';
dla_catalog_name = 'dr9q_concordance';
train_ind = ...
    [' catalog.in_dr9                     & ' ...
     '(catalog.filter_flags == 0)         & ' ...
     ' catalog.los_inds(dla_catalog_name) & ' ...
     '~catalog.dla_inds(dla_catalog_name)'];

% should install minFunc first. please refer to the main folder
training_set_name = 'dr9q_minus_concordance';
learn_qso_model_meanflux;
```

We also have to re-generate the samples because we changed `alpha = 0.97`:

```matlab
training_release  = 'dr12q';
generate_dla_samples_multi;
```

And then, re-processing your test set:

```matlab
% in MATLAB
mex voigt.c -lcerf

% specify the learned quasar model to use
training_release  = 'dr12q';
training_set_name = 'dr9q_minus_concordance';

% specify the spectra to use for computing the DLA existence prior
dla_catalog_name  = 'dr9q_concordance';
prior_ind = ...
    [' prior_catalog.in_dr9 & ' ...
     ' prior_catalog.los_inds(dla_catalog_name) & ' ...
     '(prior_catalog.filter_flags == 0)'];

% specify the spectra to process
release = 'dr12q';
test_set_name = 'dr12q';
test_ind = '(catalog.filter_flags == 0)';

% generate sub-DLA samples
set_lls_parameters;

% process the spectra with multi-DLAs and mean-flux suppression
process_qsos_multiple_dlas_meanflux;
```
